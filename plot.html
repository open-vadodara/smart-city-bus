<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenStreetMap Example</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 80vh;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1>Map with Points and Path</h1>
  <div id="map"></div>

  <label for="bus-route">Choose a route:</label>
  <!-- <input list="bus-routes" id="bus-route" name="bus-route" /> -->
  <select id="bus-routes" onchange="showRoute(this.value)"></select>

  <h2>Route time table</h2>
  <table>
    <thead>
      <tr>
        <th>Start Time (city bus center)</th>
        <th>End Time (last stop)</th>
      </tr>
    </thead>
    <tbody id="timetable"></tbody>
  </table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

  // load routes names & timetable for routes (filenames only) into memory
  const ROUTES_DATA = {};
  const TT_DATA = {};
  fetch('./route_details/')
  .then(response => response.text())    // response is a stream, so we need to convert it to text
  .then(data => {
    const parser = new DOMParser(); 
    const htmlDoc = parser.parseFromString(data, 'text/html');
    const links = htmlDoc.querySelectorAll('a');
    links.forEach(link => {
      const fileName = link.getAttribute('href');
      if(fileName.endsWith('.json')) {
        if(fileName.startsWith('tt_')) {  // timetable data
          TT_DATA[fileName.replace('tt_', '').replace('.json', '')] = fileName;
        } else {                    // route data
          ROUTES_DATA[fileName.replace('.json', '')] = fileName;
        }
      }
    });
  })
  .catch(error => console.error('Error reading route_details folder:', error));

  // Create the map instance and set initial view
  const map = L.map("map").setView([22.3220818, 73.0906863], 13);

  // Add OpenStreetMap tiles to the map
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);
  
  /**
   * Given a list of routes, load the dropdown with the routes
   * 
   * @param `routes` <object> - list of routes with route name as key and file name as value
   */
  function loadDropDown(routes) {
    const select = document.getElementById('bus-routes');
    for(const route in routes) {
      const option = document.createElement('option');
      option.value = routes[route].replace('.json', '');
      option.text = route;
      select.appendChild(option);
    }
  }

  /**
   * Given set of routes, load the timetable for those routes
   * 
   * @param `routes` <array> - list of route file name for .json data
   */
  function showTimeTable(routes) {
    // const files = routes.map((r) => jsonFiles[r].substring(3, jsonFiles[r].length))
    // const tt_table = document.getElementById('timetable')
    timetable.map((file) => {
      fetch(`route_details/${file}`)
      .then((response) => response.json())
      .then((data) => {
        const rows = data.map((d) => {
          return `<tr><td>${d['TRIP_TIME']}</td><td>${d['TRIP_END_TIME']}</td></tr>`
        })

        tt_table.innerHTML = rows.join('')
      })
    })
  }

  /**
   * Given a route, load the path for that route
   * @param `routes` <array> - list of route file name for .json data
   */ 
  function showRoute(route) {

    const file = ROUTES_DATA[route]

    // path data is stored int the `tt_` files
    fetch(`route_details/tt_${file}`)
      .then((response) => response.json())
      .then((data) => {
        const table = data['Table']
        const path_coordinates = []

        // Plot each point
        table.forEach((point) => {
          const marker = L.marker(point.LATLAN.split(' ').reverse()).addTo(map);
          marker.bindPopup(`<b>${file.substring(3, file.length - 5)} - ${point.POI_NAME}</b> -> ${point.REACH_TIME}`);

          point.TRAVELPATH.substring(12, point.TRAVELPATH.length - 1).split(', ').forEach((item) => {
            path_coordinates.push(item.split(' ').reverse().map(a => parseFloat(a)))
          })
        });

        // this is because of the data issue in the JSON files
        const path_coords_no_dupes = removeDuplicateArrays(path_coordinates)
        
        // Plot the path using GeoJSON
        const geoJsonPath = {
          type: "Feature",
          geometry: {
            'type': 'LineString',
            'coordinates': path_coords_no_dupes
          },
          properties: {},
        };
        // console.log(geoJsonPath);
        L.geoJSON(geoJsonPath, {
          style: {
            color: "blue",
            weight: 4,
            opacity: 0.7,
          },
        }).addTo(map);
      })
      .catch((error) => {
        console.error("Error loading JSON data:", error);
      })
    // )
  }


  function removeDuplicateArrays(arrayOfArrays) {
    // Use a Set to store unique stringified arrays
    const uniqueSet = new Set();

    // Filter the array to remove duplicates
    return arrayOfArrays.filter((arr) => {
      const stringified = JSON.stringify(arr); // Convert the array to a string
      if (uniqueSet.has(stringified)) {
        return false; // Duplicate found, filter it out
      } else {
        uniqueSet.add(stringified); // Add to Set and keep it
        return true; // Keep this array
      }
    });
  }

  window.onload = (evt) => {
    
    loadDropDown(ROUTES_DATA)
    // show default routes
    // showRoutes(['2U', '23', '21'])

    // display all routes
    Object.keys(ROUTES_DATA).map(e => showRoute(e))
  }

</script>
</body>
</html>